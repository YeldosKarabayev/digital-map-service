{"ast":null,"code":"import{Outlet,Link}from\"react-router-dom\";import{useEffect,useRef,useState}from'react';import{useRefreshMutation}from\"./authApiSlice\";import usePersist from\"../../hooks/usePersist\";import{useSelector}from'react-redux';import{selectCurrentToken}from\"./authSlice\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const PersistLogin=()=>{const[persist]=usePersist();const token=useSelector(selectCurrentToken);const effectRan=useRef(false);const[trueSuccess,setTrueSuccess]=useState(false);const[refresh,{isUninitialized,isLoading,isSuccess,isError,error}]=useRefreshMutation();useEffect(()=>{if(effectRan.current===true||process.env.NODE_ENV!=='development'){// React 18 Strict Mode\nconst verifyRefreshToken=async()=>{console.log('verifying refresh token');try{//const response = \nawait refresh();//const { accessToken } = response.data\nsetTrueSuccess(true);}catch(err){console.error(err);}};if(!token&&persist)verifyRefreshToken();}return()=>effectRan.current=true;// eslint-disable-next-line\n},[]);let content;if(!persist){// persist: no\nconsole.log('no persist');content=/*#__PURE__*/_jsx(Outlet,{});}else if(isLoading){//persist: yes, token: no\nconsole.log('loading');content=/*#__PURE__*/_jsx(\"p\",{children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430...\"});}else if(isError){var _error$data;//persist: yes, token: no\nconsole.log('error');content=/*#__PURE__*/_jsxs(\"p\",{className:\"errmsg\",children:[\"\".concat(error===null||error===void 0?void 0:(_error$data=error.data)===null||_error$data===void 0?void 0:_error$data.message,\" - \"),/*#__PURE__*/_jsx(Link,{to:\"/login\",children:\"\\u041F\\u043E\\u0436\\u0430\\u043B\\u0443\\u0439\\u0441\\u0442\\u0430, \\u0432\\u043E\\u0439\\u0434\\u0438\\u0442\\u0435 \\u0435\\u0449\\u0435 \\u0440\\u0430\\u0437\"}),\".\"]});}else if(isSuccess&&trueSuccess){//persist: yes, token: yes\nconsole.log('success');content=/*#__PURE__*/_jsx(Outlet,{});}else if(token&&isUninitialized){//persist: yes, token: yes\nconsole.log('token and uninit');console.log(isUninitialized);content=/*#__PURE__*/_jsx(Outlet,{});}return content;};export default PersistLogin;","map":{"version":3,"names":["Outlet","Link","useEffect","useRef","useState","useRefreshMutation","usePersist","useSelector","selectCurrentToken","jsx","_jsx","jsxs","_jsxs","PersistLogin","persist","token","effectRan","trueSuccess","setTrueSuccess","refresh","isUninitialized","isLoading","isSuccess","isError","error","current","process","env","NODE_ENV","verifyRefreshToken","console","log","err","content","children","_error$data","className","concat","data","message","to"],"sources":["C:/Users/MSI/Desktop/final-map-app/client/client/src/features/auth/PersistLogin.js"],"sourcesContent":["import { Outlet, Link } from \"react-router-dom\"\r\nimport { useEffect, useRef, useState } from 'react'\r\nimport { useRefreshMutation } from \"./authApiSlice\"\r\nimport usePersist from \"../../hooks/usePersist\"\r\nimport { useSelector } from 'react-redux'\r\nimport { selectCurrentToken } from \"./authSlice\"\r\n\r\nconst PersistLogin = () => {\r\n\r\n    const [persist] = usePersist()\r\n    const token = useSelector(selectCurrentToken)\r\n    const effectRan = useRef(false)\r\n\r\n    const [trueSuccess, setTrueSuccess] = useState(false)\r\n\r\n    const [refresh, {\r\n        isUninitialized,\r\n        isLoading,\r\n        isSuccess,\r\n        isError,\r\n        error\r\n    }] = useRefreshMutation()\r\n\r\n\r\n    useEffect(() => {\r\n\r\n        if (effectRan.current === true || process.env.NODE_ENV !== 'development') { // React 18 Strict Mode\r\n\r\n            const verifyRefreshToken = async () => {\r\n                console.log('verifying refresh token')\r\n                try {\r\n                    //const response = \r\n                    await refresh()\r\n                    //const { accessToken } = response.data\r\n                    setTrueSuccess(true)\r\n                }\r\n                catch (err) {\r\n                    console.error(err)\r\n                }\r\n            }\r\n\r\n            if (!token && persist) verifyRefreshToken()\r\n        }\r\n\r\n        return () => effectRan.current = true\r\n\r\n        // eslint-disable-next-line\r\n    }, [])\r\n\r\n\r\n    let content\r\n    if (!persist) { // persist: no\r\n        console.log('no persist')\r\n        content = <Outlet />\r\n    } else if (isLoading) { //persist: yes, token: no\r\n        console.log('loading')\r\n        content = <p>Загрузка...</p>\r\n    } else if (isError) { //persist: yes, token: no\r\n        console.log('error')\r\n        content = (\r\n            <p className='errmsg'>\r\n                {`${error?.data?.message} - `}\r\n                <Link to=\"/login\">Пожалуйста, войдите еще раз</Link>.\r\n            </p>\r\n        )\r\n    } else if (isSuccess && trueSuccess) { //persist: yes, token: yes\r\n        console.log('success')\r\n        content = <Outlet />\r\n    } else if (token && isUninitialized) { //persist: yes, token: yes\r\n        console.log('token and uninit')\r\n        console.log(isUninitialized)\r\n        content = <Outlet />\r\n    }\r\n\r\n    return content\r\n}\r\nexport default PersistLogin"],"mappings":"AAAA,OAASA,MAAM,CAAEC,IAAI,KAAQ,kBAAkB,CAC/C,OAASC,SAAS,CAAEC,MAAM,CAAEC,QAAQ,KAAQ,OAAO,CACnD,OAASC,kBAAkB,KAAQ,gBAAgB,CACnD,MAAO,CAAAC,UAAU,KAAM,wBAAwB,CAC/C,OAASC,WAAW,KAAQ,aAAa,CACzC,OAASC,kBAAkB,KAAQ,aAAa,QAAAC,GAAA,IAAAC,IAAA,CAAAC,IAAA,IAAAC,KAAA,yBAEhD,KAAM,CAAAC,YAAY,CAAGA,CAAA,GAAM,CAEvB,KAAM,CAACC,OAAO,CAAC,CAAGR,UAAU,CAAC,CAAC,CAC9B,KAAM,CAAAS,KAAK,CAAGR,WAAW,CAACC,kBAAkB,CAAC,CAC7C,KAAM,CAAAQ,SAAS,CAAGb,MAAM,CAAC,KAAK,CAAC,CAE/B,KAAM,CAACc,WAAW,CAAEC,cAAc,CAAC,CAAGd,QAAQ,CAAC,KAAK,CAAC,CAErD,KAAM,CAACe,OAAO,CAAE,CACZC,eAAe,CACfC,SAAS,CACTC,SAAS,CACTC,OAAO,CACPC,KACJ,CAAC,CAAC,CAAGnB,kBAAkB,CAAC,CAAC,CAGzBH,SAAS,CAAC,IAAM,CAEZ,GAAIc,SAAS,CAACS,OAAO,GAAK,IAAI,EAAIC,OAAO,CAACC,GAAG,CAACC,QAAQ,GAAK,aAAa,CAAE,CAAE;AAExE,KAAM,CAAAC,kBAAkB,CAAG,KAAAA,CAAA,GAAY,CACnCC,OAAO,CAACC,GAAG,CAAC,yBAAyB,CAAC,CACtC,GAAI,CACA;AACA,KAAM,CAAAZ,OAAO,CAAC,CAAC,CACf;AACAD,cAAc,CAAC,IAAI,CAAC,CACxB,CACA,MAAOc,GAAG,CAAE,CACRF,OAAO,CAACN,KAAK,CAACQ,GAAG,CAAC,CACtB,CACJ,CAAC,CAED,GAAI,CAACjB,KAAK,EAAID,OAAO,CAAEe,kBAAkB,CAAC,CAAC,CAC/C,CAEA,MAAO,IAAMb,SAAS,CAACS,OAAO,CAAG,IAAI,CAErC;AACJ,CAAC,CAAE,EAAE,CAAC,CAGN,GAAI,CAAAQ,OAAO,CACX,GAAI,CAACnB,OAAO,CAAE,CAAE;AACZgB,OAAO,CAACC,GAAG,CAAC,YAAY,CAAC,CACzBE,OAAO,cAAGvB,IAAA,CAACV,MAAM,GAAE,CAAC,CACxB,CAAC,IAAM,IAAIqB,SAAS,CAAE,CAAE;AACpBS,OAAO,CAACC,GAAG,CAAC,SAAS,CAAC,CACtBE,OAAO,cAAGvB,IAAA,MAAAwB,QAAA,CAAG,qDAAW,CAAG,CAAC,CAChC,CAAC,IAAM,IAAIX,OAAO,CAAE,KAAAY,WAAA,CAAE;AAClBL,OAAO,CAACC,GAAG,CAAC,OAAO,CAAC,CACpBE,OAAO,cACHrB,KAAA,MAAGwB,SAAS,CAAC,QAAQ,CAAAF,QAAA,KAAAG,MAAA,CACbb,KAAK,SAALA,KAAK,kBAAAW,WAAA,CAALX,KAAK,CAAEc,IAAI,UAAAH,WAAA,iBAAXA,WAAA,CAAaI,OAAO,qBACxB7B,IAAA,CAACT,IAAI,EAACuC,EAAE,CAAC,QAAQ,CAAAN,QAAA,CAAC,gJAA2B,CAAM,CAAC,IACxD,EAAG,CACN,CACL,CAAC,IAAM,IAAIZ,SAAS,EAAIL,WAAW,CAAE,CAAE;AACnCa,OAAO,CAACC,GAAG,CAAC,SAAS,CAAC,CACtBE,OAAO,cAAGvB,IAAA,CAACV,MAAM,GAAE,CAAC,CACxB,CAAC,IAAM,IAAIe,KAAK,EAAIK,eAAe,CAAE,CAAE;AACnCU,OAAO,CAACC,GAAG,CAAC,kBAAkB,CAAC,CAC/BD,OAAO,CAACC,GAAG,CAACX,eAAe,CAAC,CAC5Ba,OAAO,cAAGvB,IAAA,CAACV,MAAM,GAAE,CAAC,CACxB,CAEA,MAAO,CAAAiC,OAAO,CAClB,CAAC,CACD,cAAe,CAAApB,YAAY","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}